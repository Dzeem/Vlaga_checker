#include <Arduino.h>
#include "led.h"
#include "wi_fi.h"
#include "tg.h"

//–°–æ–∑–¥–∞–µ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã:
LED blue(D1);   // –°–∏–Ω–∏–π
LED green(D2);  // –ó–µ–ª–µ–Ω—ã–π
LED yellow(D5); // –ñ–µ–ª—Ç—ã–π
LED orange(D6); // –û—Ä–∞–Ω–∂–µ–≤—ã–π
LED red(D7);    // –ö—Ä–∞—Å–Ω—ã–π
LED* LEDS[] = {&blue, &green, &yellow, &orange, &red}; // –ú–∞—Å—Å–∏–≤ —Å–æ –≤—Å–µ–º–∏ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞–º–∏
const int LEDSlength = sizeof(LEDS) / sizeof(LEDS[0]);

bool messageForwarded = false; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è —á—Ç–æ–± –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç—ã—â—É —Ä–∞–∑ —É–≤–µ–¥—ã –≤ —Ç–≥
unsigned long checkTime = 0; // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
unsigned long nowTime; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã ESP


void setup() {
  Serial.begin(9600); // –ó–∞–ø—É—Å–∫–∞–µ–º Serial (–ø–æ—Ä—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä –ø–æ—Ä—Ç–∞)
  WiFiConnect(); // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Wi-Fi + –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  sendTelegramMessage("–ó–∞–ø—É—Å–∫–∞—é —Å–∫–∞–Ω–µ—Ä –ø–æ—á–≤—ã..."); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
}

void loop() {
  nowTime = millis();
  if (nowTime - checkTime >= 2000) {
    checkTime = nowTime;
    int vlaga = analogRead(A0);  // –ß–∏—Ç–∞–µ–º –≤–ª–∞–∂–Ω–æ—Å—Ç—å —Å –∞–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –≤—Ö–æ–¥–∞ A0 (0‚Äì1023)
    Serial.print("–í–ª–∞–∂–Ω–æ—Å—Ç—å: ");    // –ü–µ—á–∞—Ç–∞–µ–º –≤ –º–æ–Ω–∏—Ç–æ—Ä –ø–æ—Ä—Ç–∞ —Ç–µ–∫—Å—Ç
    Serial.println(vlaga);       // –ü–µ—á–∞—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ + –ø–µ—Ä–µ—Ö–æ–¥ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –Ω–æ–≤—É—é

    if (vlaga < 300) {
      LEDSoff();   // –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã
      blue.on();     // –í–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥ –Ω–∞ –ø–µ—Ä–µ–ª–∏–≤
      messageForwarded = false;    
    } else if (vlaga < 600) {
      LEDSoff();   // –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã
      green.on();    // –ò–Ω–∞—á–µ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥ –Ω–∞ –Ω–æ—Ä–º
      messageForwarded = false;
    } else if (vlaga < 650) {
      LEDSoff();   // –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã
      yellow.on();   // –ò–Ω–∞—á–µ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥ –Ω–∞ –ø–æ–¥—Å–æ—Ö
      messageForwarded = false;
    } else if (vlaga < 700) {

      orange.on();   // –ò–Ω–∞—á–µ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥ –Ω–∞ –∑–∞—Å—ã—Ö–∞–µ—Ç
      messageForwarded = false;
    } else {
      LEDSoff();   // –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã
      red.on();      // –ò–Ω–∞—á–µ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥ –Ω–∞ –∑–∞—Å–æ—Ö
      if (messageForwarded == false) {
        String msg = "üö® –¶–≤–µ—Ç–æ—á–µ–∫ –ø–æ–º–∏—Ä–∞–µ—Ç! –í–ª–∞–∂–Ω–æ—Å—Ç—å: " + String(vlaga) + ". –ü–æ—Ä–∞ –ø–æ–ª–∏–≤–∞—Ç—å!";
        sendTelegramMessage(msg);
        messageForwarded = true;
      }    
    }
  }
}